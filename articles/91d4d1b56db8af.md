---
title: "Content Collectionsã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['nextjs', 'contentlayer', 'contentcollections']
published: true
---


## Content Collectionsã¨ã¯

[Content Collections](https://www.content-collections.dev/)ã¯ã€2024å¹´ã«ç™»å ´ã—ãŸTypeSafeãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚[Contentlayerã®å¾Œç¶™](https://github.com/contentlayerdev/contentlayer/issues/429)ã¨ã—ã¦æ³¨ç›®ã•ã‚Œã¦ãŠã‚Šã€ã‚ˆã‚Šç°¡æ½”ã§ä½¿ã„ã‚„ã™ã„è¨­è¨ˆã«ãªã£ã¦ã„ã¾ã™ã€‚[Supa Starter](https://supastarter.dev/docs/nextjs/tech-stack#content-collections)ã§ã‚‚æ¡ç”¨ã•ã‚Œã¦ã„ã‚‹ãªã©ã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã‚‚æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

ä¸»ãªç‰¹å¾´ï¼š
- TypeSafeã§ã‚ã‚‹ã“ã¨
- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å¼·åŠ›ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- HMRï¼ˆHot Module Replacementï¼‰å¯¾å¿œ

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆNext.jsï¼‰

:::message
ã™ã§ã«Content Collectionsã®å°å…¥ãŒå®Œäº†ã—ã¦ã„ã‚‹æ–¹ã¯ã€ã“ã®ç« ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ã€Œãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§æ›¸ããŸã„ã€ã‹ã‚‰èª­ã¿é€²ã‚ã¦ãã ã•ã„ã€‚
:::

ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«Content Collectionsã‚’å°å…¥ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ï¼š

```bash
pnpm add @content-collections/core @content-collections/next zod -D
```

### tsconfig.jsonã®èª¿æ•´

ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```json:tsconfig.json
{
  "compilerOptions": {
    // ...
    "paths": {
      "@/*": ["./*"],
      "content-collections": ["./.content-collections/generated"]
    }
  }
}
```

### Next.jsè¨­å®šã®æ›´æ–°

```ts:next.config.ts
import type { NextConfig } from "next";
import { withContentCollections } from "@content-collections/next";

const nextConfig: NextConfig = {
  /* config options here */
};

// withContentCollections must be the outermost plugin
export default withContentCollections(nextConfig);
```

### .gitignoreã«è¿½åŠ 

ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Gitã§ç„¡è¦–ã™ã‚‹ã‚ˆã†è¨­å®šã—ã¾ã™ï¼š

```gitignore:.gitignore
.content-collections
```

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«`content-collections.ts`ã‚’ä½œæˆï¼š

```ts:content-collections.ts
import { defineCollection, defineConfig } from "@content-collections/core";
import { z } from "zod";

const posts = defineCollection({
  name: "posts",
  directory: "src/posts",
  include: "**/*.md",
  schema: z.object({
    title: z.string(),
    summary: z.string(),
  }),
});

export default defineConfig({
  collections: [posts],
});
```

### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

ä¾‹ã¨ã—ã¦`src/posts/hello-world.md`ã‚’ä½œæˆï¼š

```md:src/posts/hello-world.md
---
title: "Hello world"
summary: "This is my first post!"
---

# Hello world

This is my first post!
```

ã“ã‚Œã§åŸºæœ¬çš„ãªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å®Œäº†ã§ã™ã€‚ã“ã“ã‹ã‚‰ã¯ã€Content Collectionsã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹ã«ã‚ãŸã£ã¦ã€å¿…è¦ãªãƒšãƒ¼ã‚¸ã‚„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆã®ä»•æ–¹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã§æ›¸ããŸã„

Content Collectionsã§ã¯ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®å…¬å¼ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ `@content-collections/markdown` ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€`compileMarkdown`ã‚’ä½¿ã†ã“ã¨ã§HTMLã«å¤‰æ›ã§ãã¾ã™ã€‚
```ts:content-collections.ts
import { defineCollection, defineConfig } from "@content-collections/core";
import { compileMarkdown } from "@content-collections/markdown";
import { z } from "zod";

const posts = defineCollection({
  name: "posts",
  directory: "content/posts",
  include: "*.md",
  schema: z.object({
    title: z.string(),
    date: z.string(),
    published: z.boolean().default(false),
  }),
  transform: async (document, context) => {
    const html = await compileMarkdown(context, document);
    return {
      ...document,
      html,
    };
  },
});

export default defineConfig({
  collections: [posts],
});
```

ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’`post.html`ã¨ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
import { allPosts } from "content-collections";

export default function App() {
  return (
    <main>
      <h1>Posts</h1>
      <ul>
        {allPosts.map((post) => (
          <li key={post._meta.path}>
            <h2>{post.title}</h2>
            <div dangerouslySetInnerHTML={{ __html: post.html }} />
          </li>
        ))}
      </ul>
    </main>
  );
}
```

## è¨˜äº‹ã®è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œã‚ŠãŸã„

`allPosts`ã‹ã‚‰slugã‚’æŒ‡å®šã—ã¦ã€ãã®è¨˜äº‹ã®è©³ç´°ãƒšãƒ¼ã‚¸ã‚’ä½œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```tsx:app/posts/[slug]/page.tsx
import { allPosts } from "content-collections";
import { notFound } from "next/navigation";
export default async function PostPage({
  params,
}: {
  params: Promise<{ slug: string }>
}) {
  const { slug } = await params;
  const post = allPosts.find((post) => post._meta.path === slug);

  if (!post) notFound();

  return (
    <div>
      <h1>{post.title}</h1>
      <div dangerouslySetInnerHTML={{ __html: post.html }} />
    </div>
  )
}


## ã‚¿ã‚°ã‚’è¿½åŠ ã—ãŸã„

ã¾ãšcollectionã®schemaã«ã€tagsã¨ã„ã†é…åˆ—ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts
tags: z.array(z.string()).optional(),
```

`post.tags`ã‚’ä½¿ã£ã¦ã€ã‚¿ã‚°ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ã‚¿ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œã‚ŠãŸã„

ã‚¿ã‚°ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚’ä½œã‚‹ã«ã¯ã€`allPosts`ã‹ã‚‰tagsã‚’å–å¾—ã—ã€ã‚¿ã‚°ã®é‡è¤‡åˆ†ã‚’countã¨ã—ã¦å–å¾—ã—ã¾ã™ã€‚

```ts
import { allPosts } from "content-collections";
import { pipe, flatMap, groupBy, map, entries, sortBy } from "remeda";

export interface Tag {
  slug: string;
  count: number;
}

export const getAllTags = (): Tag[] => {
  return pipe(
    allPosts,
    flatMap((post) => post.tags || []), // ã‚¿ã‚°ã‚’å¹³å¦åŒ–
    groupBy((tag) => tag), // åŒã˜ã‚¿ã‚°ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    entries(), // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’é…åˆ—ã«å¤‰æ›
    map(([slug, tags]) => ({ slug, count: tags.length })), // ã‚«ã‚¦ãƒ³ãƒˆä»˜ãã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
    sortBy((tag) => -tag.count) // ä½¿ç”¨å›æ•°é †ã«ä¸¦ã¹æ›¿ãˆ
  )
}
```

:::message
ã“ã®é–¢æ•°ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚
https://inari-tech.net/posts/nextjs-tag-cloud
:::

:::message
Remedaã¨ã¯ï¼Ÿ
https://zenn.dev/kiyoshiro9446/articles/utility-remeda
:::

## ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ãŸã„

tagã¨åŒã˜ãã€collectionã®schemaã«ã€categoryã‚’è¿½åŠ ã—ã¾ã™ã€‚

```ts
category: z.string().optional(),
```

`post.category`ã‚’ä½¿ã£ã¦ã€ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


## ã¾ã¨ã‚

Content Collectionsã‚’ä½¿ã£ãŸãƒ–ãƒ­ã‚°æ§‹ç¯‰ã«ã¤ã„ã¦ã€åŸºæœ¬çš„ãªTipsã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚

**ä¸»ãªãƒã‚¤ãƒ³ãƒˆï¼š**
- TypeSafeãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†ã§DXï¼ˆé–‹ç™ºä½“é¨“ï¼‰ãŒå‘ä¸Š
- ã‚¿ã‚°ã‚„ã‚«ãƒ†ã‚´ãƒªæ©Ÿèƒ½ã‚‚æŸ”è»Ÿã«å®Ÿè£…å¯èƒ½
- HMRå¯¾å¿œã§é–‹ç™ºåŠ¹ç‡ãŒå¤§å¹…ã«æ”¹å–„

Content Collectionsã¯Contentlayerã®å¾Œç¶™ã¨ã—ã¦ã€ã‚ˆã‚Šã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„è¨­è¨ˆã«ãªã£ã¦ãŠã‚Šã€ã“ã‚Œã‹ã‚‰ãƒ–ãƒ­ã‚°ã‚’ä½œæˆã™ã‚‹æ–¹ã«ã¯ç‰¹ã«ãŠã™ã™ã‚ã§ã™ã€‚

### å‚è€ƒè¨˜äº‹
- [Content Collectionså…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.content-collections.dev/)
- [NextJSã§ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹](https://inari-tech.net/posts/nextjs-tag-cloud)
